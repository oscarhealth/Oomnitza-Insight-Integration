name: Oomnitza Insight Integration

on:
  workflow_dispatch:
    inputs:
      insight_order_creation_date_from:
        description: 'Order Creation Date From (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      insight_order_creation_date_to:
        description: 'Order Creation Date To (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      test_mode:
        description: 'Run in test mode (no upload to Oomnitza)'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 6 * * *' # Runs daily at 6:00 AM UTC

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Overall job timeout - kills job if it takes longer than 15 minutes
    env:
      OOMNITZA_URL: ${{ secrets.OOMNITZA_URL }}
      OOMNITZA_API_TOKEN: ${{ secrets.OOMNITZA_API_TOKEN }}
      INSIGHT_CLIENT_ID: ${{ secrets.INSIGHT_CLIENT_ID }}
      INSIGHT_CLIENT_KEY: ${{ secrets.INSIGHT_CLIENT_KEY }}
      INSIGHT_CLIENT_SECRET: ${{ secrets.INSIGHT_CLIENT_SECRET }}
      INSIGHT_URL: ${{ secrets.INSIGHT_URL }}
      INSIGHT_TRACKING_DATA: ${{ secrets.INSIGHT_TRACKING_DATA }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install OpenLDAP development libraries
        timeout-minutes: 3
        run: sudo apt-get update && sudo apt-get install -y libldap2-dev libsasl2-dev
      - name: Install dependencies
        timeout-minutes: 5
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Compute date range (defaults to previous UTC day)
        id: dates
        shell: bash
        run: |
          IN_START="${{ github.event.inputs.insight_order_creation_date_from }}"
          IN_END="${{ github.event.inputs.insight_order_creation_date_to }}"
          if [ -n "$IN_START" ]; then
            DATE_FROM="$IN_START"
          else
            DATE_FROM=$(date -u -d "yesterday" +%F)
          fi
          if [ -n "$IN_END" ]; then
            DATE_TO="$IN_END"
          else
            DATE_TO="$DATE_FROM"
          fi
          echo "DATE_FROM=$DATE_FROM" >> "$GITHUB_OUTPUT"
          echo "DATE_TO=$DATE_TO" >> "$GITHUB_OUTPUT"
      - name: Create config.ini
        run: |
          cat > config.ini << 'EOF'
          [oomnitza]
          enable = True
          url = placeholder
          api_token = placeholder

          [insight]
          enable = True
          client_id = placeholder
          client_key = placeholder
          client_secret = placeholder
          order_creation_date_from = 
          order_creation_date_to = 
          tracking_data = 
          insight_url = placeholder
          EOF
      - name: Run connector (manual or scheduled)
        id: sync_step
        timeout-minutes: 10  # Main sync step timeout
        env:
          # Oomnitza
          OOMNITZA_URL: ${{ secrets.OOMNITZA_URL }}
          OOMNITZA_API_TOKEN: ${{ secrets.OOMNITZA_API_TOKEN }}
          OOMNITZA_CONNECTOR_SOURCE: gha
          # Insight
          INSIGHT_URL: ${{ secrets.INSIGHT_URL }}
          INSIGHT_CLIENT_KEY: ${{ secrets.INSIGHT_CLIENT_KEY }}
          INSIGHT_CLIENT_SECRET: ${{ secrets.INSIGHT_CLIENT_SECRET }}
          INSIGHT_CLIENT_ID: ${{ secrets.INSIGHT_CLIENT_ID }}
          INSIGHT_TRACKING_DATA: ${{ secrets.INSIGHT_TRACKING_DATA }}
          INSIGHT_ORDER_CREATION_DATE_FROM: ${{ steps.dates.outputs.DATE_FROM }}
          INSIGHT_ORDER_CREATION_DATE_TO: ${{ steps.dates.outputs.DATE_TO }}
        shell: bash
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            ARGS="--testmode"
          fi
          
          # Set Python path to include current directory for local module imports
          export PYTHONPATH="$(pwd):${PYTHONPATH}"
          
          # Run the connector and capture output
          set +e  # Don't exit immediately on error
          python connector.py upload insight --ini config.ini $ARGS
          EXIT_CODE=$?
          set -e
          
          # Check for authentication errors in logs
          if [ -f errors.log ] && grep -q "401\|Unauthorized\|Authentication failure" errors.log; then
            echo "::error::‚ùå Authentication failed - Invalid or expired credentials"
            echo "AUTH_FAILED=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check for other critical errors
          if [ -f errors.log ] && grep -q "Error loading records\|Error syncing data" errors.log; then
            echo "::error::‚ùå Sync failed - Check error logs for details"
            echo "SYNC_FAILED=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Exit with the connector's exit code
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::‚ùå Connector failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Sync completed successfully"
      - name: Prepare timestamped logs
        if: always()
        shell: bash
        run: |
          # Create logs directory
          mkdir -p logs
          
          # Generate timestamp
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          RUN_ID="${{ github.run_id }}"
          DATE_RANGE="${{ steps.dates.outputs.DATE_FROM }}_to_${{ steps.dates.outputs.DATE_TO }}"
          
          # Copy logs with timestamps and metadata
          if [ -f info.log ]; then
            cp info.log "logs/info-${DATE_RANGE}-${TIMESTAMP}-run${RUN_ID}.log"
            echo "‚úÖ Copied info.log"
          else
            echo "‚ö†Ô∏è info.log not found"
            echo "No info.log generated" > "logs/info-${DATE_RANGE}-${TIMESTAMP}-run${RUN_ID}.log"
          fi
          
          if [ -f errors.log ]; then
            cp errors.log "logs/errors-${DATE_RANGE}-${TIMESTAMP}-run${RUN_ID}.log"
            echo "‚úÖ Copied errors.log"
          else
            echo "‚ö†Ô∏è errors.log not found"
            echo "No errors.log generated" > "logs/errors-${DATE_RANGE}-${TIMESTAMP}-run${RUN_ID}.log"
          fi
          
          # Create metadata file
          cat > "logs/metadata-${DATE_RANGE}-${TIMESTAMP}-run${RUN_ID}.txt" << EOF
          Oomnitza Insight Integration - Run Metadata
          ============================================
          Run ID: ${{ github.run_id }}
          Run Number: ${{ github.run_number }}
          Workflow: ${{ github.workflow }}
          Timestamp: ${TIMESTAMP} UTC
          Triggered By: ${{ github.event_name }}
          Actor: ${{ github.actor }}
          
          Date Range:
          - From: ${{ steps.dates.outputs.DATE_FROM }}
          - To: ${{ steps.dates.outputs.DATE_TO }}
          
          Mode: ${{ github.event.inputs.test_mode == 'true' && 'Test Mode (No Upload)' || 'Production Mode' }}
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          EOF
          
          echo "üìÅ Log files prepared:"
          ls -lh logs/
          
      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connector-logs-${{ github.run_id }}
          path: logs/
          retention-days: 90
          if-no-files-found: warn
          
      - name: Notify on failure (scheduled runs)
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const logsUrl = `${runUrl}/artifacts`;
            
            const issueBody = `## ‚ö†Ô∏è Scheduled Sync Failed
            
            **Run ID:** ${context.runId}
            **Date Range:** ${{ steps.dates.outputs.DATE_FROM }} to ${{ steps.dates.outputs.DATE_TO }}
            **Triggered:** ${new Date().toISOString()}
            
            ### Failure Details
            ${context.payload.workflow_run?.conclusion === 'failure' ? '- Workflow failed' : ''}
            ${{ steps.sync_step.outputs.AUTH_FAILED == 'true' && '- ‚ùå **Authentication failed** - Invalid or expired Insight API credentials' || '' }}
            ${{ steps.sync_step.outputs.SYNC_FAILED == 'true' && '- ‚ùå **Sync failed** - Error loading or processing data' || '' }}
            
            ### Actions Required
            ${${{ steps.sync_step.outputs.AUTH_FAILED == 'true' }} ? `
            1. Verify Insight API credentials in GitHub Secrets:
               - \`INSIGHT_CLIENT_ID\`
               - \`INSIGHT_CLIENT_KEY\`
               - \`INSIGHT_CLIENT_SECRET\`
            2. Check if API account is active
            3. Re-run workflow after updating credentials
            ` : `
            1. Check error logs in [artifacts](${logsUrl})
            2. Review [workflow run](${runUrl}) for details
            3. Fix the underlying issue
            4. Re-run the workflow
            `}
            
            ### Links
            - [Workflow Run](${runUrl})
            - [Download Logs](${logsUrl})
            - [Repository Secrets](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions)
            
            ---
            *This issue was automatically created by the Oomnitza Insight Integration workflow.*
            `;
            
            // Create an issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Oomnitza Sync Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['automated', 'sync-failure', 'urgent']
            });
            
      - name: Add job summary
        if: always()
        shell: bash
        run: |
          echo "## üìä Oomnitza Insight Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date Range:** ${{ steps.dates.outputs.DATE_FROM }} to ${{ steps.dates.outputs.DATE_TO }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ github.event.inputs.test_mode == 'true' && 'Test Mode (No Upload)' || 'Production Mode' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.sync_step.outputs.AUTH_FAILED }}" = "true" ]; then
            echo "### ‚ùå Authentication Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Invalid or expired Insight API credentials." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Update GitHub Secrets with valid credentials" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify API account is active" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sync_step.outputs.SYNC_FAILED }}" = "true" ]; then
            echo "### ‚ùå Sync Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Error occurred during data synchronization." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check error logs in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "2. Review workflow logs for details" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "### ‚úÖ Sync Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Data synchronized from Insight to Oomnitza." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f errors.log ] && [ -s errors.log ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>‚ö†Ô∏è Error Log (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 errors.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "No errors logged ‚úÖ" >> $GITHUB_STEP_SUMMARY
          fi
